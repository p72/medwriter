<!DOCTYPE html>
<!-- HTML5の文書タイプ宣言 - 最新のHTML標準を使用 -->
<html lang="ja">
<!-- 日本語のページであることを指定 -->
<head>
    <!-- 文字エンコーディングをUTF-8に設定 - 日本語文字を正しく表示するため -->
    <meta charset="UTF-8">
    <!-- ビューポート設定 - モバイル端末での表示を最適化 -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- ページのタイトル - ブラウザのタブに表示される -->
    <title>MedWriter</title>
    <style>
        /* === CSS スタイル定義開始 === */
        /* 全体のスタイル設定 */
        body {
            font-family: 'Helvetica Neue', Arial, sans-serif; /* フォントファミリーを設定 */
            margin: 0; /* 外側の余白を0に */
            padding: 20px; /* 内側の余白を20pxに */
            background-color: #f5f5f5; /* 背景色を薄いグレーに */
        }

        /* ヘッダー部分のスタイル */
        .header {
            background-color: #4CAF50; /* ヘッダーの背景色を緑に */
            color: white; /* テキストを白に */
            padding: 20px; /* 内側の余白を20pxに */
            text-align: center; /* テキストを中央揃えに */
            margin-bottom: 20px; /* 下の余白を20pxに */
            border-radius: 5px; /* 角を丸く */
        }

        /* メインコンテンツのスタイル */
        .container {
            max-width: 1200px; /* 最大幅を1200pxに */
            margin: 0 auto; /* 左右の余白を自動で中央揃えに */
            padding: 20px; /* 内側の余白を20pxに */
            background-color: white; /* 背景色を白に */
            border-radius: 5px; /* 角を丸く */
            box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* 影をつける */
        }

        /* フォームのスタイル */
        .form-group {
            margin-bottom: 15px; /* 下の余白を15pxに */
        }

        .form-group label {
            display: block; /* ラベルをブロック要素に */
            margin-bottom: 5px; /* 下の余白を5pxに */
            color: #333; /* テキスト色を濃いグレーに */
        }

        .form-group input, .form-group textarea {
            width: 100%; /* 幅を100%に */
            padding: 8px; /* 内側の余白を8pxに */
            border: 1px solid #ddd; /* 枠線を薄いグレーに */
            border-radius: 4px; /* 角を丸く */
            box-sizing: border-box; /* パディングを幅に含める */
        }

        /* ボタンのスタイル */
        .btn {
            background-color: #4CAF50; /* 背景色を緑に */
            color: white; /* テキストを白に */
            padding: 10px 20px; /* 内側の余白を上下10px、左右20pxに */
            border: none; /* 枠線を消す */
            border-radius: 4px; /* 角を丸く */
            cursor: pointer; /* カーソルをポインターに */
            font-size: 16px; /* フォントサイズを16pxに */
        }

        .btn:hover {
            background-color: #45a049; /* ホバー時の背景色を少し暗い緑に */
        }

        /* テーブルのスタイル */
        table {
            width: 100%; /* 幅を100%に */
            border-collapse: collapse; /* テーブルの枠線を結合 */
            margin-top: 20px; /* 上の余白を20pxに */
        }

        th, td {
            padding: 12px; /* 内側の余白を12pxに */
            text-align: left; /* テキストを左揃えに */
            border-bottom: 1px solid #ddd; /* 下の枠線を薄いグレーに */
        }

        th {
            background-color: #f8f8f8; /* 背景色を薄いグレーに */
            font-weight: bold; /* フォントを太字に */
        }

        /* 検索ボックスのスタイル */
        .search-box {
            margin-bottom: 20px; /* 下の余白を20pxに */
            padding: 10px; /* 内側の余白を10pxに */
            background-color: #f8f8f8; /* 背景色を薄いグレーに */
            border-radius: 4px; /* 角を丸く */
        }

        .search-box input {
            width: 100%; /* 幅を100%に */
            padding: 8px; /* 内側の余白を8pxに */
            border: 1px solid #ddd; /* 枠線を薄いグレーに */
            border-radius: 4px; /* 角を丸く */
            box-sizing: border-box; /* パディングを幅に含める */
        }

        /* 削除ボタンのスタイル */
        .delete-btn {
            background-color: #f44336; /* 背景色を赤に */
            color: white; /* テキストを白に */
            padding: 5px 10px; /* 内側の余白を上下5px、左右10pxに */
            border: none; /* 枠線を消す */
            border-radius: 3px; /* 角を丸く */
            cursor: pointer; /* カーソルをポインターに */
        }

        .delete-btn:hover {
            background-color: #da190b; /* ホバー時の背景色を少し暗い赤に */
        }

        /* 編集ボタンのスタイル */
        .edit-btn {
            background-color: #2196F3; /* 背景色を青に */
            color: white; /* テキストを白に */
            padding: 5px 10px; /* 内側の余白を上下5px、左右10pxに */
            border: none; /* 枠線を消す */
            border-radius: 3px; /* 角を丸く */
            cursor: pointer; /* カーソルをポインターに */
            margin-right: 5px; /* 右の余白を5pxに */
        }

        .edit-btn:hover {
            background-color: #0b7dda; /* ホバー時の背景色を少し暗い青に */
        }

        /* モーダルのスタイル */
        .modal {
            display: none; /* 初期状態では非表示 */
            position: fixed; /* 位置を固定 */
            z-index: 1; /* 重なり順を設定 */
            left: 0; /* 左端に配置 */
            top: 0; /* 上端に配置 */
            width: 100%; /* 幅を100%に */
            height: 100%; /* 高さを100%に */
            background-color: rgba(0,0,0,0.4); /* 背景色を半透明の黒に */
        }

        .modal-content {
            background-color: #fefefe; /* 背景色を白に */
            margin: 15% auto; /* 上下の余白を15%、左右を自動で中央揃えに */
            padding: 20px; /* 内側の余白を20pxに */
            border: 1px solid #888; /* 枠線をグレーに */
            width: 80%; /* 幅を80%に */
            max-width: 500px; /* 最大幅を500pxに */
            border-radius: 5px; /* 角を丸く */
        }

        .close {
            color: #aaa; /* 色を薄いグレーに */
            float: right; /* 右寄せに */
            font-size: 28px; /* フォントサイズを28pxに */
            font-weight: bold; /* フォントを太字に */
            cursor: pointer; /* カーソルをポインターに */
        }

        .close:hover {
            color: black; /* ホバー時の色を黒に */
        }

        @media (max-width: 768px) {
            .form-group {
                flex-direction: column;
                gap: 5px;
            }

            .form-group label {
                flex: none;
                width: 100%;
                padding-top: 0;
            }

            .button-group {
                flex-direction: column;
            }

            .button {
                width: 100%;
            }

            .records-table {
                display: block;
                overflow-x: auto;
            }
        }

        .required {
            color: #e74c3c;
            margin-left: 4px;
        }

        .form-group input:required,
        .form-group textarea:required {
            border-left: 3px solid #e74c3c;
        }

        .advice-section {
            margin-top: 20px;
            padding: 15px;
            background-color: #f8f9fa;
            border-radius: 5px;
            border: 1px solid #dee2e6;
        }

        .advice-content {
            margin-top: 10px;
            padding: 10px;
            background-color: white;
            border-radius: 4px;
            border: 1px solid #ced4da;
            white-space: pre-wrap;
        }

        .advice-title {
            font-size: 12px;
            font-weight: bold;
            color: #2c3e50;
        }

        .loading {
            color: #666;
            font-style: italic;
        }

        .error {
            color: #dc3545;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <!-- メインコンテナ - ページ全体のコンテンツを包含 -->
    <div class="container">
        <!-- ヘッダーセクション - アプリケーションのタイトル表示 -->
        <div class="header">
            <h1>MedWriter</h1>
        </div>

        <!-- フォームセクション - 患者情報と診療内容の入力エリア -->
        <div class="form-section">
            <!-- 患者基本情報入力フィールド群 -->
            <div class="form-group">
                <label for="patientId">患者ID <span class="required">*</span></label>
                <input type="text" id="patientId" required tabindex="1">
            </div>
            <div class="form-group">
                <label for="patientName">患者氏名 <span class="required">*</span></label>
                <input type="text" id="patientName" required tabindex="2">
            </div>
            <div class="form-group">
                <label for="visitDate">診療日 <span class="required">*</span></label>
                <input type="date" id="visitDate" required value="" tabindex="3">
            </div>
            
            <!-- 診療内容入力フィールド群 -->
            <div class="form-group">
                <label for="problem">Problem list <span class="required">*</span></label>
                <textarea id="problem" required tabindex="4"></textarea>
            </div>
            <div class="form-group">
                <label for="treatment">診察治療<span class="required">*</span></label>
                <textarea id="treatment" rows="4" required tabindex="5"></textarea>
            </div>

            <!-- AI機能設定セクション -->
            <div class="form-group">
                <label for="apiKey">OpenAI API Key</label>
                <!-- パスワードタイプでAPIキーを隠して入力 -->
                <input type="password" id="apiKey" placeholder="sk-..." tabindex="-1">
            </div>

            <div class="form-group">
                <label for="modelSelect">AIモデル</label>
                <!-- 使用するAIモデルを指定（デフォルトはgpt-4o） -->
                <input type="text" id="modelSelect" class="model-select" value="gpt-4o" placeholder="例: gpt-4, gpt-3.5-turbo" tabindex="-1">
            </div>

            <!-- AIアドバイス取得ボタン -->
            <div class="form-group">
                <button type="button" id="getAdvice" class="btn btn-secondary" tabindex="-1">AIアドバイスを取得</button>
            </div>
            
            <!-- AIアドバイス表示エリア（初期状態では非表示） -->
            <div id="adviceSection" class="advice-section" style="display: none;">
                <div class="advice-title">AIからのアドバイス</div>
                <div id="adviceContent" class="advice-content"></div>
            </div>
            </div>

        <!-- 操作ボタン群 - 記録の追加・更新・ファイル操作 -->
        <div class="button-group">
            <!-- 新規記録追加ボタン -->
            <button class="button button-primary" onclick="addRecord()" tabindex="-1">診療記録追加</button>
            <!-- 既存記録更新ボタン（記録選択時のみ表示） -->
            <button class="button button-warning" onclick="updateSelectedRecord()" id="updateButton" style="display: none;" tabindex="-1">更新</button>
            <!-- データエクスポートボタン（CSV形式でダウンロード） -->
            <button class="button button-secondary" onclick="exportData()" tabindex="-1">データエクスポート</button>
            <!-- データインポートボタン（CSVファイルから読み込み） -->
            <button class="button button-secondary" onclick="importData()" tabindex="-1">データインポート</button>
            <!-- 全データ削除ボタン（確認ダイアログ付き） -->
            <button class="button button-danger" onclick="clearData()" tabindex="-1">データクリア</button>
        </div>

        <!-- 診療履歴表示セクション - 保存された記録の一覧表示 -->
        <div class="records-section">
            <h2>診療履歴</h2>
            <!-- 診療記録テーブル -->
            <table class="records-table">
                <!-- テーブルヘッダー - 各列の項目名 -->
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>氏名</th>
                        <th>診療日</th>
                        <th>Problem list</th>
                        <th>診察治療</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <!-- テーブルボディ - JavaScriptで動的に記録を挿入 -->
                <tbody id="recordsList"></tbody>
            </table>
        </div>
        </div>

    <!-- モーダルウィンドウ - 診療記録の詳細表示用ポップアップ -->
    <div id="recordModal" class="modal">
        <div class="modal-content">
            <!-- モーダル閉じるボタン（×マーク） -->
            <span class="close" onclick="closeModal()">&times;</span>
            <h2>診療記録詳細</h2>
            <!-- 選択された記録の詳細情報を表示するエリア -->
            <div id="recordDetails"></div>
        </div>
    </div>

    <script>
        // === JavaScript 処理開始 ===
        
        /* 定数定義 - アプリケーション全体で使用する固定値 */
        
        // 必須入力項目のフィールドID一覧
        // バリデーション時にこの配列をチェックして入力漏れを防ぐ
        const REQUIRED_FIELDS = ['patientId', 'patientName', 'visitDate', 'problem'];
        
        // エラーメッセージ定数 - ユーザーに表示するメッセージを一元管理
        const ERROR_MESSAGES = {
            required: '患者ID、患者氏名、診療日、Problem listは必須項目です。',
            export: 'エクスポート中にエラーが発生しました: ',
            import: 'インポート中にエラーが発生しました: ',
            clear: 'すべてのデータを削除しますか？',
            cleared: 'データを削除しました',
            update: '記録を更新しますか？',
            updated: '記録を更新しました'
        };

        /* グローバル変数 - アプリケーション全体で共有するデータ */
        
        // 診療記録を保存する配列 - メモリ上でデータを管理
        let records = [];
        // 現在選択中の記録のID - 更新機能で使用
        let selectedRecordId = null;

        /* === ユーティリティ関数群 === */
        /* 汎用的な機能を提供する関数たち */
        
        /**
         * 一意のIDを生成する関数
         * 現在の時刻（ミリ秒）とランダム文字列を組み合わせて、
         * 重複しないIDを作成する
         * @returns {string} 生成された一意のID
         */
        function generateId() {
            // Date.now()で現在時刻（ミリ秒）を36進数に変換
            // Math.random()でランダム文字列を生成して結合
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        /**
         * 日付文字列を日本語形式にフォーマットする関数
         * YYYY-MM-DD形式の日付を日本語の表示形式に変換
         * @param {string} dateString - 変換する日付文字列
         * @returns {string} 日本語形式の日付文字列
         */
        function formatDate(dateString) {
            return new Date(dateString).toLocaleDateString('ja-JP');
        }

        /**
         * 必須項目の入力チェックを行う関数
         * REQUIRED_FIELDS配列に定義された全てのフィールドが
         * 入力されているかを確認する
         * @returns {boolean} 全ての必須項目が入力済みならtrue
         */
        function validateRequiredFields() {
            // every()メソッドで全ての必須フィールドをチェック
            return REQUIRED_FIELDS.every(field => {
                const element = document.getElementById(field);
                // 要素が存在し、かつ値が空でないことを確認
                return element && element.value.trim() !== '';
            });
        }

        /* === データ操作関数群 === */
        /* 診療記録の追加、更新、削除などの基本機能 */
        
        /**
         * 新しい診療記録を追加する関数
         * フォームの入力値を取得して、records配列に新しい記録を追加
         * 必須項目のバリデーションも実行する
         */
        function addRecord() {
            // 必須項目のチェック - 未入力があればエラーメッセージを表示して終了
            if (!validateRequiredFields()) {
                alert(ERROR_MESSAGES.required);
                return;
            }

            // フォームの各入力値を取得してレコードオブジェクトを作成
            const record = {
                id: generateId(), // 一意のIDを生成
                patientId: document.getElementById('patientId').value,
                patientName: document.getElementById('patientName').value,
                visitDate: document.getElementById('visitDate').value,
                problem: document.getElementById('problem').value,
                treatment: document.getElementById('treatment').value
            };

            // records配列にレコードを追加
            records.push(record);
            // 画面の記録一覧を更新
            updateRecordsList();
            // フォームをクリア
            clearForm();
        }

        function updateSelectedRecord() {
            if (!selectedRecordId) return;
            if (!validateRequiredFields()) {
                alert(ERROR_MESSAGES.required);
                return;
            }
            
            if (confirm(ERROR_MESSAGES.update)) {
                const index = records.findIndex(r => r.id === selectedRecordId);
                if (index !== -1) {
                    records[index] = {
                        id: selectedRecordId,
                        patientId: document.getElementById('patientId').value,
                        patientName: document.getElementById('patientName').value,
                        visitDate: document.getElementById('visitDate').value,
                        problem: document.getElementById('problem').value,
                        treatment: document.getElementById('treatment').value
                    };
            updateRecordsList();
                    clearForm();
                    alert(ERROR_MESSAGES.updated);
                }
            }
        }

        function updateRecordsList() {
            const tbody = document.getElementById('recordsList');
            tbody.innerHTML = '';

            records.forEach(record => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${record.patientId}</td>
                    <td>${record.patientName}</td>
                    <td>${formatDate(record.visitDate)}</td>
                    <td>${record.problem}</td>
                    <td>${record.treatment}</td>
                    <td>
                        <div class="action-buttons">
                            <button class="button button-primary" onclick="selectRecord('${record.id}')">選択</button>
                            <button class="button button-danger" onclick="deleteRecord('${record.id}')">削除</button>
                    </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function selectRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            selectedRecordId = id;
            document.getElementById('patientId').value = record.patientId;
            document.getElementById('patientName').value = record.patientName;
            document.getElementById('visitDate').value = record.visitDate;
            document.getElementById('problem').value = record.problem;
            document.getElementById('treatment').value = record.treatment;

            // 更新ボタンを表示
            document.getElementById('updateButton').style.display = 'inline-block';
        }

        function clearForm() {
            document.getElementById('patientId').value = '';
            document.getElementById('patientName').value = '';
            document.getElementById('visitDate').value = '';
            document.getElementById('problem').value = '';
            document.getElementById('treatment').value = '';
            selectedRecordId = null;
            document.getElementById('updateButton').style.display = 'none';
        }

        // モーダル操作
        function viewRecord(id) {
            const record = records.find(r => r.id === id);
            if (!record) return;

            const details = document.getElementById('recordDetails');
            details.innerHTML = `
                <p><strong>患者ID:</strong> ${record.patientId}</p>
                <p><strong>患者氏名:</strong> ${record.patientName}</p>
                <p><strong>診療日:</strong> ${formatDate(record.visitDate)}</p>
                <p><strong>Problem list:</strong> ${record.problem}</p>
                <p><strong>診察治療:</strong> ${record.treatment}</p>
            `;

            document.getElementById('recordModal').style.display = 'block';
        }

        function closeModal() {
            document.getElementById('recordModal').style.display = 'none';
        }

        function deleteRecord(id) {
            if (confirm('この記録を削除しますか？')) {
                records = records.filter(record => record.id !== id);
                updateRecordsList();
            }
        }

        /* === データ入出力関数群 === */
        /* ファイルのエクスポート・インポート機能 */
        
        /**
         * 診療記録をCSVファイルとしてエクスポートする関数
         * 現在メモリ上にある全ての記録をCSV形式でダウンロードする
         * ファイル名には現在日付を含める
         */
        function exportData() {
            try {
                // 現在の日付を取得（ISO形式からYYYY-MM-DD部分を抽出）
                const date = new Date().toISOString().split('T')[0];
                
                // エクスポートファイル名を生成（例：medical_records_2024-03-21.csv）
                const fileName = `medical_records_${date}.csv`;
                
                // ヘッダー行を定義
                const headers = ['ID', '患者ID', '患者氏名', '診療日', 'Problem list', '診察治療'];
                
                // CSVデータを生成
                const csv = [
                    // ヘッダー行を追加
                    headers.join(','),
                    // レコードデータを追加
                    ...records.map(record => {
                        // 各フィールドをダブルクォートで囲み、内部のダブルクォートは2重にする
                        const fields = [
                            record.id,
                            record.patientId,
                            record.patientName,
                            record.visitDate,
                            record.problem,
                            record.treatment
                        ].map(field => {
                            // 改行を\nに変換し、ダブルクォートをエスケープ
                            const escaped = String(field)
                                .replace(/"/g, '""')  // ダブルクォートをエスケープ
                                .replace(/\n/g, '\\n') // 改行をエスケープ
                                .replace(/\r/g, '\\r'); // キャリッジリターンをエスケープ
                            return `"${escaped}"`;
                        });
                        return fields.join(',');
                    })
                ].join('\n');
                
                // BOMを追加してUTF-8でエンコード
                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = fileName;
                link.click();
                
                // メモリリークを防ぐためにURLを解放
                URL.revokeObjectURL(link.href);
            } catch (error) {
                alert(ERROR_MESSAGES.export + error.message);
            }
        }

        function importData() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.csv';
            
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                
                reader.onload = function(event) {
                    try {
                        const csv = event.target.result;
                        const lines = csv.split('\n');
                        
                        // ヘッダー行をスキップ
                        const dataLines = lines.slice(1);
                        
                        records = dataLines.map(line => {
                            // CSVパース処理
                            const fields = [];
                            let currentField = '';
                            let inQuotes = false;
                            
                            for (let i = 0; i < line.length; i++) {
                                const char = line[i];
                                if (char === '"') {
                                    if (inQuotes && line[i + 1] === '"') {
                                        // エスケープされたダブルクォート
                                        currentField += '"';
                                        i++;
                                    } else {
                                        inQuotes = !inQuotes;
                                    }
                                } else if (char === ',' && !inQuotes) {
                                    fields.push(currentField);
                                    currentField = '';
                                } else {
                                    currentField += char;
                                }
                            }
                            fields.push(currentField);
                            
                            // フィールドの処理
                            const [id, patientId, patientName, visitDate, problem, treatment] = fields.map(field => {
                                // 改行を復元
                                return field.replace(/\\n/g, '\n').replace(/\\r/g, '\r');
                            });
                            
                            return { id, patientId, patientName, visitDate, problem, treatment };
                        }).filter(record => record.id); // 空行を除外
                        
                        updateRecordsList();
                    } catch (error) {
                        alert(ERROR_MESSAGES.import + error.message);
                    }
                };
                
                reader.readAsText(file, 'UTF-8');
            };
            
            input.click();
        }

        function clearData() {
            if (confirm(ERROR_MESSAGES.clear)) {
                records = [];
                updateRecordsList();
                alert(ERROR_MESSAGES.cleared);
            }
        }

        /* === AI機能関連設定 === */
        /* OpenAI APIを使用したアドバイス機能の設定と処理 */
        
        // OpenAI APIのエンドポイントURL
        const OPENAI_API_URL = 'https://api.openai.com/v1/chat/completions';
        
        // AIに送信するシステムプロンプト（AIの役割と指示を定義）
        // 経験豊富な総合内科医として、実用的なアドバイスを提供するよう指示
        const SYSTEM_PROMPT = `#あなたは経験豊富な総合内科医です。診療記録の内容を確認し、
#実際の外来臨床で、役立つ内容を、箇条書きで10個
#ピットフォールやtipsを。
#限りなくコンパクトに。略語可
`;

        /**
         * OpenAI APIを使用してAIアドバイスを取得する非同期関数
         * 入力されたProblem listと診察治療内容を基に、
         * 臨床で役立つアドバイスを生成して表示する
         */
        async function getAIAdvice() {
            const apiKey = document.getElementById('apiKey').value;
            const problem = document.getElementById('problem').value;
            const treatment = document.getElementById('treatment').value;
            const model = document.getElementById('modelSelect').value;

            if (!apiKey) {
                alert('API Keyを入力してください。');
                return;
            }

            if (!problem && !treatment) {
                alert('Problem listまたは診察治療の内容を入力してください。');
                return;
            }

            const adviceSection = document.getElementById('adviceSection');
            const adviceContent = document.getElementById('adviceContent');
            const getAdviceButton = document.getElementById('getAdvice');

            try {
                // ボタンを無効化し、ローディング表示
                getAdviceButton.disabled = true;
                adviceSection.style.display = 'block';
                adviceContent.innerHTML = '<div class="loading">アドバイスを生成中...</div>';

                const response = await fetch(OPENAI_API_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${apiKey}`
                    },
                    body: JSON.stringify({
                        model: model,
                        messages: [
                            { role: 'system', content: SYSTEM_PROMPT },
                            { role: 'user', content: `Problem list: ${problem}\n\n診察治療: ${treatment}` }
                        ],
                        temperature: 0.7,
                        max_tokens: 1000
                    })
                });

                if (!response.ok) {
                    throw new Error(`API Error: ${response.status}`);
                }

                const data = await response.json();
                const advice = data.choices[0].message.content;
                adviceContent.innerHTML = advice;

            } catch (error) {
                console.error('Error:', error);
                adviceContent.innerHTML = `<div class="error">エラーが発生しました: ${error.message}</div>`;
            } finally {
                getAdviceButton.disabled = false;
            }
        }

        /* === イベントリスナーの設定 === */
        /* ボタンクリック等のユーザー操作に対する処理を登録 */
        
        // AIアドバイス取得ボタンにクリックイベントを設定
        document.getElementById('getAdvice').addEventListener('click', getAIAdvice);

        /* === アプリケーション初期化処理 === */
        /* ページ読み込み時に実行される初期設定 */
        
        // 診療記録一覧の表示を初期化（空の状態で表示）
        updateRecordsList();

        // 診療日フィールドに現在の日付を自動設定
        // valueAsDateを使用して今日の日付をデフォルト値として設定
        document.getElementById('visitDate').valueAsDate = new Date();

        /* === ページ離脱時の処理 === */
        
        /**
         * ページを離れる際の確認ダイアログ
         * 未保存のデータがある場合に警告を表示して、
         * 誤って作業内容を失うことを防ぐ
         */
        window.onbeforeunload = function() {
            // 記録が1件以上ある場合のみ確認ダイアログを表示
            if (records.length > 0) {
                return '変更が保存されていません。このページを離れますか？';
            }
        };
    </script>
</body>
</html>